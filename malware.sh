import yara
import os

# Ruta donde est√° el malware y las reglas YARA compiladas
MALWARE_DIR = os.path.expanduser("~/Downloads/malware1")
RULES_PATH = os.path.join(MALWARE_DIR, "rules-compiled")

def load_yara_rules():
    try:
        rules = yara.load(filepath=RULES_PATH)
        print("[+] Reglas YARA cargadas correctamente.")
        return rules
    except Exception as e:
        print(f"[-] Error cargando reglas YARA: {e}")
        return None

def scan_malware(rules):
    if not rules:
        return
    
    print(f"\n[+] Escaneando archivos en: {MALWARE_DIR}")
    
    for filename in os.listdir(MALWARE_DIR):
        file_path = os.path.join(MALWARE_DIR, filename)
        
        # Ignorar el archivo de reglas compiladas
        if filename == "rules-compiled":
            continue
        
        if os.path.isfile(file_path):
            try:
                matches = rules.match(filepath=file_path)
                if matches:
                    print(f"\nüî• **Malware detectado en {filename}**")
                    for match in matches:
                        print(f"  - Regla: {match.rule}")
                        if match.meta.get("description"):
                            print(f"    Descripci√≥n: {match.meta['description']}")
                else:
                    print(f"‚úÖ {filename} - No se detectaron amenazas.")
            except Exception as e:
                print(f"[-] Error escaneando {filename}: {e}")

if __name__ == "__main__":
    print("\nüîç Iniciando escaneo YARA...")
    yara_rules = load_yara_rules()
    scan_malware(yara_rules)
    print("\nüéØ Escaneo completado.")



